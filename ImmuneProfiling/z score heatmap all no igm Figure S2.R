
# Load the required libraries
library(readxl)
library(pheatmap)
library(viridis)

# Read the data
Data_mean <- read_excel("C:/Users/gantak/OneDrive - UMass Chan Medical School/Desktop/EBV manuscript/data/Heatmap_EBNA1.xlsx")
# Generate unique row names
row_names <- make.unique(paste(
  Data_mean$`SAMPLE ID`,
  Data_mean$participants,
  Data_mean$EBV_infection,
  sep = "_"
))

# Drop metadata columns
Data_mean <- Data_mean[, !colnames(Data_mean) %in% c("participants", "SAMPLE ID", "visit", "EBV_infection", "History", "Total_IgG")]

# Ensure only numeric columns are selected
Data_mean <- Data_mean[sapply(Data_mean, is.numeric)]

# Scale the data to Z-scores (center and scale)
Data_mean_scaled <- scale(Data_mean, center = TRUE, scale = TRUE)

# Convert to a matrix and assign row names
Data_mean_scaled <- as.matrix(Data_mean_scaled)
rownames(Data_mean_scaled) <- row_names

# Transpose the matrix
Data_mean_scaled <- t(Data_mean_scaled)

# Define the valid column order (ensure matching columns exist in the dataset)
# Define the valid column order (ensure matching columns exist in the dataset)
desired_col_order <- c("1537 v1_1537_Acute (n = 97)",
                       "1531 v1_1531_Acute (n = 97)",
                       "1538 v1_1538_Acute (n = 97)",
                       "1536 v1_1536_Acute (n = 97)",
                       "1539 v1_1539_Acute (n = 97)",
                       "1527 v1_1527_Acute (n = 97)",
                       "1568 v1_1568_Acute (n = 97)",
                       "1582 v1_1582_Acute (n = 97)",
                       "1541 v1_1541_Acute (n = 97)",
                       "1545 v1_1545_Acute (n = 97)",
                       "1558 v1_1558_Acute (n = 97)",
                       "1572 v1_1572_Acute (n = 97)",
                       "1575 v2_1575_Acute (n = 97)",
                       "1585 v1_1585_Acute (n = 97)",
                       "1550 v1_1550_Acute (n = 97)",
                       "1564 v1_1564_Acute (n = 97)",
                       "1578 v1_1578_Acute (n = 97)",
                       "1542 v1_1542_Acute (n = 97)",
                       "1569 v1_1569_Acute (n = 97)",
                       "1583 v1_1583_Acute (n = 97)",
                       "1547 v1_1547_Acute (n = 97)",
                       "1559 v1_1559_Acute (n = 97)",
                       "1586 v1_1586_Acute (n = 97)",
                       "1576 v1_1576_Acute (n = 97)",
                       "1587 v1_1587_Acute (n = 97)",
                       "1555 v1_1555_Acute (n = 97)",
                       "1567 v1_1567_Acute (n = 97)",
                       "1580 v1_1580_Acute (n = 97)",
                       "1543 v1_1543_Acute (n = 97)",
                       "1570 v1_1570_Acute (n = 97)",
                       "1573 v1_1573_Acute (n = 97)",
                       "1584 v1_1584_Acute (n = 97)",
                       "1548 v1_1548_Acute (n = 97)",
                       "1556 v1_1556_Acute (n = 97)",
                       "1563 v1_1563_Acute (n = 97)",
                       "1577 v1_1577_Acute (n = 97)",
                       "1588 v1_1588_Acute (n = 97)",
                       "1591 v1_1591_Acute (n = 97)",
                       "1598 v1_1598_Acute (n = 97)",
                       "1612 v1_1612_Acute (n = 97)",
                       "1624 v2_1624_Acute (n = 97)",
                       "1603 v2_1603_Acute (n = 97)",
                       "1618 v1_1618_Acute (n = 97)",
                       "1627 v1_1627_Acute (n = 97)",
                       "1589 v1_1589_Acute (n = 97)",
                       "1593 v2_1593_Acute (n = 97)",
                       "1607 v1_1607_Acute (n = 97)",
                       "1622 v1_1622_Acute (n = 97)",
                       "1633 v1_1633_Acute (n = 97)",
                       "1600 v1_1600_Acute (n = 97)",
                       "1614 v1_1614_Acute (n = 97)",
                       "1625 v1_1625_Acute (n = 97)",
                       "1604 v1_1604_Acute (n = 97)",
                       "1620 v1_1620_Acute (n = 97)",
                       "1630 v1_1630_Acute (n = 97)",
                       "1590 v1_1590_Acute (n = 97)",
                       "1594 v1_1594_Acute (n = 97)",
                       "1611 v1_1611_Acute (n = 97)",
                       "1623 v1_1623_Acute (n = 97)",
                       "1634 v1_1634_Acute (n = 97)",
                       "1602 v1_1602_Acute (n = 97)",
                       "1617 v1_1617_Acute (n = 97)",
                       "1626 v1_1626_Acute (n = 97)",
                       "1605 v1_1605_Acute (n = 97)",
                       "1621 v1_1621_Acute (n = 97)",
                       "1632 v2_1632_Acute (n = 97)",
                       "1635 v1_1635_Acute (n = 97)",
                       "1649 v1_1649_Acute (n = 97)",
                       "1659 v1_1659_Acute (n = 97)",
                       "1665 v1_1665_Acute (n = 97)",
                       "1679 v1_1679_Acute (n = 97)",
                       "1639 v1_1639_Acute (n = 97)",
                       "1653 v1_1653_Acute (n = 97)",
                       "1670 v1_1670_Acute (n = 97)",
                       "1685 v1_1685_Acute (n = 97)",
                       "1646 v1_1646_Acute (n = 97)",
                       "1657 v1_1657_Acute (n = 97)",
                       "1675 v1_1675_Acute (n = 97)",
                       "1636 v1_1636_Acute (n = 97)",
                       "1651 v2_1651_Acute (n = 97)",
                       "1663 v1_1663_Acute (n = 97)",
                       "1666 v1_1666_Acute (n = 97)",
                       "1681 v1_1681_Acute (n = 97)",
                       "1641 v1_1641_Acute (n = 97)",
                       "1654 v1_1654_Acute (n = 97)",
                       "1671 v1_1671_Acute (n = 97)",
                       "1648 v1_1648_Acute (n = 97)",
                       "1658 v1_1658_Acute (n = 97)",
                       "1664 v1_1664_Acute (n = 97)",
                       "1676 v1_1676_Acute (n = 97)",
                       "1637 v1_1637_Acute (n = 97)",
                       "1652 v1_1652_Acute (n = 97)",
                       "1667 v1_1667_Acute (n = 97)",
                       "1684 v1_1684_Acute (n = 97)",
                       "1645 v1_1645_Acute (n = 97)",
                       "1655 v2_1655_Acute (n = 97)",
                       "1674 v1_1674_Acute (n = 97)",
                       "1527 v6_1527_6 weeks (n = 67)",
                       "1537 v5_1537_6 weeks (n = 67)",
                       "1531 v6_1531_6 weeks (n = 67)",
                       "1548 v6_1548_6 weeks (n = 67)",
                       "1563 v6_1563_6 weeks (n = 67)",
                       "1577 v6_1577_6 weeks (n = 67)",
                       "1568 v6_1568_6 weeks (n = 67)",
                       "1582 v6_1582_6 weeks (n = 67)",
                       "1545 v6_1545_6 weeks (n = 67)",
                       "1558 v6_1558_6 weeks (n = 67)",
                       "1575 v6_1575_6 weeks (n = 67)",
                       "1585 v6_1585_6 weeks (n = 67)",
                       "1550 v6_1550_6 weeks (n = 67)",
                       "1564 v5_1564_6 weeks (n = 67)",
                       "1542 v6_1542_6 weeks (n = 67)",
                       "1569 v5_1569_6 weeks (n = 67)",
                       "1559 v6_1559_6 weeks (n = 67)",
                       "1576 v5_1576_6 weeks (n = 67)",
                       "1587 v5_1587_6 weeks (n = 67)",
                       "1567 v6_1567_6 weeks (n = 67)",
                       "1543 v6_1543_6 weeks (n = 67)",
                       "1570 v6_1570_6 weeks (n = 67)",
                       "1573 v5_1573_6 weeks (n = 67)",
                       "1588 v6_1588_6 weeks (n = 67)",
                       "1632 v6_1632_6 weeks (n = 67)",
                       "1624 v6_1624_6 weeks (n = 67)",
                       "1618 v5_1618_6 weeks (n = 67)",
                       "1607 v6_1607_6 weeks (n = 67)",
                       "1622 v6_1622_6 weeks (n = 67)",
                       "1633 v6_1633_6 weeks (n = 67)",
                       "1600 v6_1600_6 weeks (n = 67)",
                       "1614 v6_1614_6 weeks (n = 67)",
                       "1625 v5_1625_6 weeks (n = 67)",
                       "1620 v6_1620_6 weeks (n = 67)",
                       "1630 v6_1630_6 weeks (n = 67)",
                       "1590 v6_1590_6 weeks (n = 67)",
                       "1594 v5_1594_6 weeks (n = 67)",
                       "1611 v5_1611_6 weeks (n = 67)",
                       "1623 v5_1623_6 weeks (n = 67)",
                       "1634 v6_1634_6 weeks (n = 67)",
                       "1617 v6_1617_6 weeks (n = 67)",
                       "1626 v6_1626_6 weeks (n = 67)",
                       "1645 v6_1645_6 weeks (n = 67)",
                       "1655 v6_1655_6 weeks (n = 67)",
                       "1674 v6_1674_6 weeks (n = 67)",
                       "1635 v6_1635_6 weeks (n = 67)",
                       "1649 v6_1649_6 weeks (n = 67)",
                       "1665 v6_1665_6 weeks (n = 67)",
                       "1679 v6_1679_6 weeks (n = 67)",
                       "1639 v6_1639_6 weeks (n = 67)",
                       "1653 v5_1653_6 weeks (n = 67)",
                       "1670 v6_1670_6 weeks (n = 67)",
                       "1646 v6_1646_6 weeks (n = 67)",
                       "1657 v6_1657_6 weeks (n = 67)",
                       "1675 v6_1675_6 weeks (n = 67)",
                       "1636 v6_1636_6 weeks (n = 67)",
                       "1651 v6_1651_6 weeks (n = 67)",
                       "1666 v5_1666_6 weeks (n = 67)",
                       "1681 v6_1681_6 weeks (n = 67)",
                       "1641 v6_1641_6 weeks (n = 67)",
                       "1648 v6_1648_6 weeks (n = 67)",
                       "1658 v6_1658_6 weeks (n = 67)",
                       "1664 v6_1664_6 weeks (n = 67)",
                       "1676 v5_1676_6 weeks (n = 67)",
                       "1637 v6_1637_6 weeks (n = 67)",
                       "1652 v5_1652_6 weeks (n = 67)",
                       "1667 v6_1667_6 weeks (n = 67)",
                       "1531 v7_1531_6 months (n = 30)",
                       "1538 v7_1538_6 months (n = 30)",
                       "1563 v7_1563_6 months (n = 30)",
                       "1577 v7_1577_6 months (n = 30)",
                       "1568 v7_1568_6 months (n = 30)",
                       "1582 v7_1582_6 months (n = 30)",
                       "1564 v7_1564_6 months (n = 30)",
                       "1578 v7_1578_6 months (n = 30)",
                       "1602 v7_1602_6 months (n = 30)",
                       "1621 v7_1621_6 months (n = 30)",
                       "1612 v7_1612_6 months (n = 30)",
                       "1624 v7_1624_6 months (n = 30)",
                       "1627 v7_1627_6 months (n = 30)",
                       "1589 v7_1589_6 months (n = 30)",
                       "1667 v7_1667_6 months (n = 30)",
                       "1684 v7_1684_6 months (n = 30)",
                       "1655 v7_1655_6 months (n = 30)",
                       "1674 v7_1674_6 months (n = 30)",
                       "1649 v7_1649_6 months (n = 30)",
                       "1665 v7_1665_6 months (n = 30)",
                       "1679 v7_1679_6 months (n = 30)",
                       "1670 v7_1670_6 months (n = 30)",
                       "1685 v7_1685_6 months (n = 30)",
                       "1675 v7_1675_6 months (n = 30)",
                       "1666 v7_1666_6 months (n = 30)",
                       "1681 v7_1681_6 months (n = 30)",
                       "1671 v7_1671_6 months (n = 30)",
                       "1648 v7_1648_6 months (n = 30)",
                       "1664 v7_1664_6 months (n = 30)",
                       "1676 v7_1676_6 months (n = 30)",
                       "1527 v8_1527_1 year (n = 67)",
                       "1537 v8_1537_1 year (n = 67)",
                       "1536 v8_1536_1 year (n = 67)",
                       "1539 v8_1539_1 year (n = 67)",
                       "1543 v8_1543_1 year (n = 67)",
                       "1556 v8_1556_1 year (n = 67)",
                       "1570 v8_1570_1 year (n = 67)",
                       "1573 v8_1573_1 year (n = 67)",
                       "1584 v8_1584_1 year (n = 67)",
                       "1548 v8_1548_1 year (n = 67)",
                       "1541 v8_1541_1 year (n = 67)",
                       "1545 v8_1545_1 year (n = 67)",
                       "1558 v8_1558_1 year (n = 67)",
                       "1572 v8_1572_1 year (n = 67)",
                       "1575 v8_1575_1 year (n = 67)",
                       "1585 v8_1585_1 year (n = 67)",
                       "1550 v8_1550_1 year (n = 67)",
                       "1542 v8_1542_1 year (n = 67)",
                       "1569 v8_1569_1 year (n = 67)",
                       "1586 v8_1586_1 year (n = 67)",
                       "1583 v8_1583_1 year (n = 67)",
                       "1547 v8_1547_1 year (n = 67)",
                       "1555 v8_1555_1 year (n = 67)",
                       "1559 v8_1559_1 year (n = 67)",
                       "1576 v8_1576_1 year (n = 67)",
                       "1587 v8_1587_1 year (n = 67)",
                       "1567 v8_1567_1 year (n = 67)",
                       "1580 v8_1580_1 year (n = 67)",
                       "1617 v8_1617_1 year (n = 67)",
                       "1626 v8_1626_1 year (n = 67)",
                       "1588 v8_1588_1 year (n = 67)",
                       "1591 v8_1591_1 year (n = 67)",
                       "1605 v8_1605_1 year (n = 67)",
                       "1632 v8_1632_1 year (n = 67)",
                       "1598 v8_1598_1 year (n = 67)",
                       "1603 v8_1603_1 year (n = 67)",
                       "1618 v8_1618_1 year (n = 67)",
                       "1593 v8_1593_1 year (n = 67)",
                       "1607 v8_1607_1 year (n = 67)",
                       "1622 v8_1622_1 year (n = 67)",
                       "1633 v8_1633_1 year (n = 67)",
                       "1600 v8_1600_1 year (n = 67)",
                       "1614 v8_1614_1 year (n = 67)",
                       "1625 v8_1625_1 year (n = 67)",
                       "1604 v8_1604_1 year (n = 67)",
                       "1620 v8_1620_1 year (n = 67)",
                       "1630 v8_1630_1 year (n = 67)",
                       "1590 v8_1590_1 year (n = 67)",
                       "1594 v8_1594_1 year (n = 67)",
                       "1611 v8_1611_1 year (n = 67)",
                       "1623 v8_1623_1 year (n = 67)",
                       "1634 v8_1634_1 year (n = 67)",
                       "1637 v8_1637_1 year (n = 67)",
                       "1652 v8_1652_1 year (n = 67)",
                       "1645 v8_1645_1 year (n = 67)",
                       "1635 v8_1635_1 year (n = 67)",
                       "1659 v8_1659_1 year (n = 67)",
                       "1639 v8_1639_1 year (n = 67)",
                       "1653 v8_1653_1 year (n = 67)",
                       "1646 v8_1646_1 year (n = 67)",
                       "1657 v8_1657_1 year (n = 67)",
                       "1663 v8_1663_1 year (n = 67)",
                       "1636 v8_1636_1 year (n = 67)",
                       "1651 v8_1651_1 year (n = 67)",
                       "1641 v8_1641_1 year (n = 67)",
                       "1654 v8_1654_1 year (n = 67)",
                       "1658 v8_1658_1 year (n = 67)",
                       "ES375_ES375_Sero_Pos (n = 50)",
                       "ES450_ES450_Sero_Pos (n = 50)",
                       "ES587_ES587_Sero_Pos (n = 50)",
                       "ES363_ES363_Sero_Pos (n = 50)",
                       "ES411_ES411_Sero_Pos (n = 50)",
                       "ES432_ES432_Sero_Pos (n = 50)",
                       "ES379_ES379_Sero_Pos (n = 50)",
                       "ES451_ES451_Sero_Pos (n = 50)",
                       "ES344_ES344_Sero_Pos (n = 50)",
                       "ES365_ES365_Sero_Pos (n = 50)",
                       "ES414_ES414_Sero_Pos (n = 50)",
                       "ES437_ES437_Sero_Pos (n = 50)",
                       "ES382_ES382_Sero_Pos (n = 50)",
                       "ES452_ES452_Sero_Pos (n = 50)",
                       "ES346_ES346_Sero_Pos (n = 50)",
                       "ES366_ES366_Sero_Pos (n = 50)",
                       "ES415_ES415_Sero_Pos (n = 50)",
                       "ES457_ES457_Sero_Pos (n = 50)",
                       "ES393_ES393_Sero_Pos (n = 50)",
                       "ES455_ES455_Sero_Pos (n = 50)",
                       "ES350_ES350_Sero_Pos (n = 50)",
                       "ES373_ES373_Sero_Pos (n = 50)",
                       "ES418_ES418_Sero_Pos (n = 50)",
                       "ES459_ES459_Sero_Pos (n = 50)",
                       "ES396_ES396_Sero_Pos (n = 50)",
                       "ES487_ES487_Sero_Pos (n = 50)",
                       "ES352_ES352_Sero_Pos (n = 50)",
                       "ES374_ES374_Sero_Pos (n = 50)",
                       "ES420_ES420_Sero_Pos (n = 50)",
                       "ES494_ES494_Sero_Pos (n = 50)",
                       "ES356_ES356_Sero_Pos (n = 50)",
                       "ES433_ES433_Sero_Pos (n = 50)",
                       "ES488_ES488_Sero_Pos (n = 50)",
                       "ES353_ES353_Sero_Pos (n = 50)",
                       "ES389_ES389_Sero_Pos (n = 50)",
                       "ES424_ES424_Sero_Pos (n = 50)",
                       "ES499_ES499_Sero_Pos (n = 50)",
                       "ES371_ES371_Sero_Pos (n = 50)",
                       "ES438_ES438_Sero_Pos (n = 50)",
                       "ES489_ES489_Sero_Pos (n = 50)",
                       "ES357_ES357_Sero_Pos (n = 50)",
                       "ES394_ES394_Sero_Pos (n = 50)",
                       "ES425_ES425_Sero_Pos (n = 50)",
                       "ES501_ES501_Sero_Pos (n = 50)",
                       "ES372_ES372_Sero_Pos (n = 50)",
                       "ES440_ES440_Sero_Pos (n = 50)",
                       "ES556_ES556_Sero_Pos (n = 50)",
                       "ES360_ES360_Sero_Pos (n = 50)",
                       "ES406_ES406_Sero_Pos (n = 50)",
                       "ES426_ES426_Sero_Pos (n = 50)",
                       "ES644_ES644_NEGATIVE",
                       "ES640_ES640_NEGATIVE",
                       "ES628_ES628_NEGATIVE",
                       "ES624_ES624_NEGATIVE",
                       "ES622_ES622_NEGATIVE",
                       "ES617_ES617_NEGATIVE",
                       "ES612_ES612_NEGATIVE",
                       "ES607_ES607_NEGATIVE",
                       "ES603_ES603_NEGATIVE",
                       "ES593_ES593_NEGATIVE"
)

valid_col_order <- desired_col_order[desired_col_order %in% colnames(Data_mean_scaled)]
Data_mean_scaled <- Data_mean_scaled[, valid_col_order]

# Define EBV status
EBVstatus <- gsub(".*\\d+_(.*)", "\\1", valid_col_order)

# Create annotation dataframe
df <- data.frame(EBVstatus = EBVstatus)
row.names(df) <- colnames(Data_mean_scaled)

# Define annotation colors
group_colors <- list(
  EBVstatus = c(
    "Acute (n = 97)" = "magenta4",
    "6 weeks (n = 67)" = "dodgerblue3",
    "6 months (n = 30)" = "chocolate3",
    "1 year (n = 67)" = "darkgreen",
    "Sero_Pos (n = 50)" = "blue",
    "NEGATIVE" = "black"
  )
)

row_start_positions <- c(1, 14, 27, 40, 53, 66, 79, 92, 105)  # Updated without IgA and IgM
row_end_positions <- c(13, 26, 39, 52, 65, 78, 91, 104, 108)  # Updated for new row positions

# Calculate centered positions for row labels
centered_labels <- floor((row_start_positions + row_end_positions) / 2)

# Create annotation labels, ensuring proper centering
ann_row <- rep("", nrow(Data_mean_scaled))
labels <- c("IgG1", "IgG2", "IgG3", "IgG4", "FcαR", "FcγR2A", "FcγR3A", "ADCD", "ADCP")
ann_row[centered_labels] <- labels

# Generate heatmap
pheatmap(
  Data_mean_scaled,
  border_color = "black",
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  color = cividis(100),
  annotation_col = df,
  annotation_colors = group_colors,
  annotation_legend = TRUE,
  labels_row = ann_row,
  show_colnames = FALSE,
  gaps_col = c(97, 164, 194, 261, 311),  # Adjust gaps for your data
  gaps_row = row_end_positions,  # Use row_end_positions for row gaps
  breaks = seq(0, 1, length.out = 101),  # Adjust Z-score range
  fontsize_row = 8,
  fontsize = 8,
  legend = TRUE
)
